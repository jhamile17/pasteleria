<div class="container py-4">
  <h2 class="mb-4 text-center">Administrar Imágenes de Productos</h2>

  <!-- Mensajes -->
  <% if (mensaje) { %>
    <div class="alert alert-success"><%= mensaje %></div>
  <% } %>

  <% if (error) { %>
    <div class="alert alert-danger"><%= error %></div>
  <% } %>

  <form id="formImagen" action="/imagenes" method="POST" enctype="multipart/form-data">
    <div class="mb-3">
      <label for="categoria_id" class="form-label">Categoría</label>
      <select class="form-select" id="categoria_id" required>
        <option value="">Seleccione una categoría</option>
        <% categorias.forEach(cat => { %>
          <option value="<%= cat.id %>"><%= cat.nombre %></option>
        <% }) %>
      </select>
    </div>

    <div class="mb-3">
      <label for="producto_id" class="form-label">Producto</label>
      <select class="form-select" id="producto_id" name="producto_id" required>
        <option value="">Seleccione un producto</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="imagen" class="form-label">Subir Imagen</label>
      <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*" required>
    </div>

    <button type="submit" class="btn btn-primary">Guardar Imagen</button>
  </form>

  <h3 class="mt-5">Imágenes del Producto</h3>
  <table class="table table-bordered mt-2" id="tablaImagenes">
    <thead>
      <tr>
        <th>ID</th>
        <th>Imagen</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const categoriaSelect = document.getElementById('categoria_id');
const productoSelect = document.getElementById('producto_id');
const tablaBody = document.querySelector('#tablaImagenes tbody');

categoriaSelect.addEventListener('change', async () => {
  const categoriaId = categoriaSelect.value;
  productoSelect.innerHTML = '<option value="">Seleccione un producto</option>';
  tablaBody.innerHTML = '';

  if (!categoriaId) return;

  try {
    const res = await fetch(`/imagenes/productos/byCategoria/${categoriaId}`);
    const productos = await res.json();
    productos.forEach(p => {
      const option = document.createElement('option');
      option.value = p.id;
      option.textContent = p.nombre;
      productoSelect.appendChild(option);
    });
    if (productos.length) {
      productoSelect.value = productos[0].id;
      productoSelect.dispatchEvent(new Event('change'));
    }
  } catch (err) {
    console.error(err);
  }
});

productoSelect.addEventListener('change', async () => {
  const productoId = productoSelect.value;
  tablaBody.innerHTML = '';

  if (!productoId) return;

  try {
    const res = await fetch(`/imagenes/list/${productoId}`);
    const imagenes = await res.json();
    imagenes.forEach(img => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${img.id}</td>
        <td><img src="${img.url}" style="height:50px;"></td>
        <td>
          <button class="btn btn-sm btn-warning me-2" onclick="editarImagen(${img.id})">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="eliminarImagen(${img.id}, ${productoId})">Eliminar</button>
        </td>
      `;
      tablaBody.appendChild(tr);
    });
  } catch (err) {
    console.error(err);
  }
});

function editarImagen(id) {
  const formImagen = document.getElementById('formImagen');
  formImagen.action = `/imagenes/${id}?_method=PUT`;
  alert('Selecciona una nueva imagen y presiona "Guardar Imagen" para actualizarla.');
}

async function eliminarImagen(id, productoId) {
  if (!confirm('¿Deseas eliminar esta imagen?')) return;
  try {
    await fetch(`/imagenes/${id}`, { method: 'DELETE' });
    productoSelect.dispatchEvent(new Event('change'));
  } catch (err) {
    console.error(err);
  }
}
</script>
